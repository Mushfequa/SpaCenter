//	Expose various global items to the views
//	Note: it must be used before app.use(app.router);
//	From: http://stackoverflow.com/questions/12851408/maintain-user-login-status-in-express-js
module.exports = function (req, res, next) {
	//	Grab the username
	res.locals.username = function() {
		return (req.user)? req.user.username: undefined;
	};

	//	If we're authenticated
	res.locals.isAuthenticated = function () {
		return req.user != null;
	};

	//	Grab the mapped route name, including any slashes
	//	translated with underscores, and "index" for root, eg:
	//
	//		/users?id=5 => "users"
	//		/users/edit => "users"
	//		/users/edit/6 => "users_edit"
	//		/ => "index"
	//
	res.locals.currentRouteName = function () {
		var p = req.route.path,
			end = (p.lastIndexOf("/") > 0)? p.lastIndexOf("/") - 1: (p.lastIndexOf("?") > 0)? p.lastIndexOf("?") - 1: p.length -1;
		return end > 1? p.substr(1,end).split("/").join("_"): "index";
	};

	//	The current url
	res.locals.currentUrl = function() {
		return req.url;
	};

	next();
};